---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.19.0
  name: werfbundles.werf.io
spec:
  group: werf.io
  names:
    kind: WerfBundle
    listKind: WerfBundleList
    plural: werfbundles
    shortNames:
    - wb
    - wbs
    singular: werfbundle
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .status.phase
      name: Phase
      type: string
    - jsonPath: .status.lastAppliedTag
      name: LastAppliedTag
      type: string
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: WerfBundle is the Schema for the werfbundles API.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: "WerfBundleSpec defines the desired state of WerfBundle.\nExample:\n\n\tapiVersion:
              werf.io/v1alpha1\n\tkind: WerfBundle\n\tmetadata:\n\t  name: my-app\n\t
              \ namespace: default\n\tspec:\n\t  registry:\n\t    url: ghcr.io/org/bundle\n\t
              \   secretRef:\n\t      name: registry-creds\n\t    pollInterval: 15m\n\t
              \ converge:\n\t    serviceAccountName: werf-converge"
            properties:
              converge:
                description: Converge contains configuration for deploying the bundle
                  with werf converge.
                properties:
                  logRetentionDays:
                    default: 7
                    description: |-
                      LogRetentionDays specifies how many days completed jobs should be retained.
                      After this period, jobs are automatically cleaned up by Kubernetes.
                      If not specified, defaults to 7 days.
                    format: int32
                    minimum: 1
                    type: integer
                  resourceLimits:
                    description: |-
                      ResourceLimits specifies CPU and memory limits for werf converge jobs.
                      If not specified, defaults are used: 1 CPU and 1Gi memory.
                    properties:
                      cpu:
                        description: CPU is the CPU limit as a string (e.g., "500m",
                          "2", "1.5").
                        type: string
                      memory:
                        description: Memory is the memory limit as a string (e.g.,
                          "512Mi", "1Gi", "2G").
                        type: string
                    type: object
                  serviceAccountName:
                    description: |-
                      ServiceAccountName is the name of the ServiceAccount to use for running werf converge Jobs.
                      Required for cross-namespace deployments (when TargetNamespace differs from bundle namespace).
                      Optional for same-namespace deployments (backward compatibility with default ServiceAccount).
                      When specified, the ServiceAccount must exist in the target namespace.
                    minLength: 1
                    type: string
                  targetNamespace:
                    description: |-
                      TargetNamespace is the namespace where werf converge will deploy resources.
                      If not specified, defaults to the bundle's namespace.
                      This is also used as the fallback namespace when looking up values from ConfigMaps and Secrets.
                    type: string
                  valuesFrom:
                    description: |-
                      ValuesFrom is a list of sources to populate configuration values for werf converge.
                      Each source is treated as a YAML document and merged in array order.
                      Later sources take precedence over earlier ones in case of key conflicts.
                      Each entry must specify exactly one of ConfigMapRef or SecretRef.
                    items:
                      description: |-
                        ValuesSource represents a source of configuration values for werf converge.
                        The entire ConfigMap or Secret is treated as YAML data and merged with other sources.
                        Values are passed to werf converge as --set flags.
                        Exactly one of ConfigMapRef or SecretRef must be set.
                      properties:
                        configMapRef:
                          description: |-
                            ConfigMapRef is a reference to a ConfigMap containing values as YAML data.
                            The ConfigMap is looked up first in the WerfBundle's namespace, then in the target namespace.
                          properties:
                            name:
                              default: ""
                              description: |-
                                Name of the referent.
                                This field is effectively required, but due to backwards compatibility is
                                allowed to be empty. Instances of this type with an empty value here are
                                almost certainly wrong.
                                More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names
                              type: string
                          type: object
                          x-kubernetes-map-type: atomic
                        optional:
                          default: false
                          description: |-
                            Optional specifies whether this values source is required.
                            If false (default), the deployment fails if the ConfigMap or Secret is not found.
                            If true, the deployment proceeds even if the resource is missing.
                          type: boolean
                        secretRef:
                          description: |-
                            SecretRef is a reference to a Secret containing values as YAML data.
                            The Secret is looked up first in the WerfBundle's namespace, then in the target namespace.
                          properties:
                            name:
                              default: ""
                              description: |-
                                Name of the referent.
                                This field is effectively required, but due to backwards compatibility is
                                allowed to be empty. Instances of this type with an empty value here are
                                almost certainly wrong.
                                More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names
                              type: string
                          type: object
                          x-kubernetes-map-type: atomic
                      type: object
                      x-kubernetes-validations:
                      - message: exactly one of configMapRef or secretRef must be
                          set
                        rule: (has(self.configMapRef) && !has(self.secretRef)) ||
                          (!has(self.configMapRef) && has(self.secretRef))
                    type: array
                type: object
              registry:
                description: Registry contains configuration for accessing the OCI
                  registry where the bundle is stored.
                properties:
                  pollInterval:
                    default: 15m
                    description: |-
                      PollInterval is the interval at which to poll the registry for new tags (e.g., 15m, 1h).
                      Currently not enforced; reconciliation happens on all events plus periodic resync.
                      Proper interval enforcement will be added in a future release.
                    pattern: ^([0-9]+(ns|us|Âµs|ms|s|m|h))+$
                    type: string
                  secretRef:
                    description: SecretRef is an optional reference to a Secret containing
                      registry credentials.
                    properties:
                      name:
                        default: ""
                        description: |-
                          Name of the referent.
                          This field is effectively required, but due to backwards compatibility is
                          allowed to be empty. Instances of this type with an empty value here are
                          almost certainly wrong.
                          More info: https://kubernetes.io/docs/concepts/overview/working-with-objects/names/#names
                        type: string
                    type: object
                    x-kubernetes-map-type: atomic
                  url:
                    description: URL is the OCI registry URL (e.g., ghcr.io/org/bundle).
                    minLength: 1
                    type: string
                required:
                - url
                type: object
            required:
            - converge
            - registry
            type: object
          status:
            description: WerfBundleStatus defines the observed state of WerfBundle.
            properties:
              activeJobName:
                description: |-
                  ActiveJobName is the name of the currently active job running werf converge.
                  Set when a job is created, cleared when the job completes or fails.
                  Used for deduplication to prevent multiple jobs for the same bundle version.
                type: string
              consecutiveFailures:
                description: |-
                  ConsecutiveFailures is the number of consecutive registry polling failures.
                  Used to calculate exponential backoff. Reset to 0 on success.
                  Marked Failed if ConsecutiveFailures > 5 (after 6th consecutive error).
                format: int32
                maximum: 6
                minimum: 0
                type: integer
              lastAppliedTag:
                description: LastAppliedTag is the last successfully deployed tag.
                type: string
              lastETag:
                description: |-
                  LastETag is the ETag from the last successful registry response.
                  Used for ETag-based caching to avoid re-downloading unchanged tag lists.
                type: string
              lastErrorMessage:
                description: LastErrorMessage is the last error encountered, or empty
                  string if no error.
                type: string
              lastErrorTime:
                description: |-
                  LastErrorTime is the timestamp of the last error encountered.
                  Used to calculate backoff intervals for retries.
                format: date-time
                type: string
              lastJobLogs:
                description: |-
                  LastJobLogs are the captured logs from the most recent job (tail of output).
                  Limited to ~5KB to fit in Status; larger logs are stored in a ConfigMap instead.
                  Provides debugging visibility without requiring external log aggregation.
                type: string
              lastJobStatus:
                description: |-
                  LastJobStatus is the status of the most recent job (Succeeded, Failed, Running).
                  Provides quick visibility into the last deployment attempt without listing jobs separately.
                enum:
                - Succeeded
                - Failed
                - Running
                type: string
              lastSyncTime:
                description: LastSyncTime is the timestamp of the last successful
                  sync (nil if not yet synced).
                format: date-time
                type: string
              phase:
                description: Phase is the current phase of the bundle (Syncing, Synced,
                  Failed).
                enum:
                - Syncing
                - Synced
                - Failed
                type: string
            type: object
        type: object
    served: true
    storage: true
    subresources:
      status: {}
