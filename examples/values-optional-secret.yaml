# Optional Values Source Example
#
# This example demonstrates using the 'optional' flag to handle values sources
# that may or may not exist, allowing for flexible environment-specific configuration.
#
# What this example shows:
# - Required vs optional values sources
# - How deployment continues when optional sources are missing
# - Common use case: environment-specific secrets
# - Best practice: required base config + optional overrides
#
# Use cases for optional sources:
# - Environment-specific credentials that only exist in some environments
# - Feature flags that only apply to certain deployments
# - Override configurations that are environment-dependent
# - Development vs production credential separation
#
# To apply this example:
# 1. Update the registry URL to point to your actual bundle
# 2. Ensure the 'production' namespace exists
# 3. Create a ServiceAccount with appropriate RBAC (see docs/job-rbac.md)
# 4. Apply: kubectl apply -f values-optional-secret.yaml
# 5. Try deploying with and without the optional secret to see the difference

---
# Required base configuration - this MUST exist or deployment fails
# Contains all the essential configuration needed for the application to run
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-base-config
  namespace: k8s-werf-operator-go-system
data:
  values.yaml: |
    app:
      name: payment-service
      replicas: 2
      environment: staging
      logLevel: info

    # Default service configuration
    services:
      timeout: 30s
      retryAttempts: 3

    # Safe defaults for features
    features:
      enableCache: true
      enableMetrics: true
      enableDebug: false

---
# Optional environment-specific overrides - deployment continues if this is missing
# This Secret might only exist in production, not in dev/staging
# If it doesn't exist, the deployment uses only the base configuration
apiVersion: v1
kind: Secret
metadata:
  name: production-overrides
  namespace: k8s-werf-operator-go-system
type: Opaque
data:
  # Base64-encoded YAML:
  #   app:
  #     replicas: 5
  #     environment: production
  #     logLevel: warn
  #   features:
  #     enableDebug: false
  #   monitoring:
  #     apiKey: prod-monitoring-key-12345
  #     endpoint: https://monitoring.production.example.com
  #
  values.yaml: YXBwOgogIHJlcGxpY2FzOiA1CiAgZW52aXJvbm1lbnQ6IHByb2R1Y3Rpb24KICBsb2dMZXZlbDogd2FybgpmZWF0dXJlczoKICBlbmFibGVEZWJ1ZzogZmFsc2UKbW9uaXRvcmluZzoKICBhcGlLZXk6IHByb2QtbW9uaXRvcmluZy1rZXktMTIzNDUKICBlbmRwb2ludDogaHR0cHM6Ly9tb25pdG9yaW5nLnByb2R1Y3Rpb24uZXhhbXBsZS5jb20K

---
# WerfBundle with required and optional sources
apiVersion: werf.io/v1alpha1
kind: WerfBundle
metadata:
  name: payment-service
  namespace: k8s-werf-operator-go-system
spec:
  registry:
    url: ghcr.io/org/payment-service-bundle
    pollInterval: 15m

  converge:
    targetNamespace: production
    serviceAccountName: werf-converge
    resourceLimits:
      cpu: "2"
      memory: "2Gi"

    valuesFrom:
      # Required source - deployment FAILS if this doesn't exist
      # optional: false is the default, so we don't need to specify it
      - configMapRef:
          name: app-base-config
        # optional: false  # This is the default

      # Optional source - deployment CONTINUES if this doesn't exist
      # Use this for environment-specific config that might not be present
      - secretRef:
          name: production-overrides
        optional: true  # Deployment proceeds even if Secret is missing

    # Behavior when production-overrides exists:
    # - Values from both sources are merged
    # - app.replicas becomes 5 (overridden)
    # - app.environment becomes production (overridden)
    # - monitoring.apiKey is added
    # - All other base config values remain
    #
    # Behavior when production-overrides is missing:
    # - Only base config is used
    # - app.replicas stays 2
    # - app.environment stays staging
    # - No monitoring configuration
    # - Deployment continues successfully with base values only
    #
    # This pattern allows the same WerfBundle to work in multiple environments:
    # - Development: No production-overrides Secret, uses staging defaults
    # - Staging: No production-overrides Secret, uses staging defaults
    # - Production: Has production-overrides Secret, uses production values
